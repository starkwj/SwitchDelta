# Example ([./rpc_example.cc](./rpc_example.cc))

## Environment

- Server: 4 servers
- g++: 
- RDMA Driver: OFED 4.7-3.2.9.0
- library:  

### Library

### Build

```bash
mkdir build
cd build; cmake .. -DPERF=ON; make -j
```

## How to Run

### Basic Configuration

```c++
// in rpc_example.cc
void config() {
    /* Global configuration */
    global_config; 

    .link_type = rdma::kEnumRoCE, kEnumIB; // link type
    .func = rdma::ConnectType::RC | RAW | UD | T_LOCAL_SRQ | G_SRQ | DCT; // connect type
    .PROTOCOL_msg_size = n; // n-Byte per msg for PROTOCOL=[rc | ud | raw] 
    .one_side_rw_size = m; // m-MByte 1-side read/write region
    .srq_config; // SRQ configuration for multipacket

    /* Machine configuration for each machine*/
    machine_config;

    .server_type = server, client; // server or client
    .thread_num = n; // rpc thread number in this machine
    .dev_id = 0, 1, ...; // mlx5_0, mlx5_1
    .numa_id = 0, 1, ...; // numa0, numa1
    .numa_size; // bindcore for thread i: i + numa_id * muma_size  
    .srp_receiver = true, false; // enable srp receiver
    .srp_sender = true, false; // enable srp sender
}
```

### MemCached Configuration

`./scripts/memcached.conf`: we use memcached to exchange the RDMA QP information

### run

```bash
./rpc_example --node_id=0 --client_thread=47 --server_thread=16 --rpc_qp=0 --client_cnt=3
```

# Small Message Performance

msg size: 64 Bytes

## Basic RC

* Latency
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | client     | 323.97K    | 2.89us     | 3.04us     | 3.02us     | 3.31us     |
    +------------+------------+------------+------------+------------+------------+
    ```
    After the normal optimization:
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | client     | 329.82K    | 2.80us     | 2.97us     | 2.95us     | 3.26us     |
    +------------+------------+------------+------------+------------+------------+
    ```


* ThroughputA: 1 Thread (3clients x 8 threads x 2)

    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 2.27M      | 270.00ns   | 401.37ns   | 390.00ns   | 515.00ns   |
    +------------+------------+------------+------------+------------+------------+
    ```
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 3.65M      | 485.00ns   | 2.48us     | 2.47us     | 4.73us     |
    +------------+------------+------------+------------+------------+------------+
    ```

* ThroughputB: 16 Threads (3clients x 47 threads x 4, random)
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 21.55M     | 260.00ns   | 1.42us     | 1.03us     | 6.76us     |
    +------------+------------+------------+------------+------------+------------+
    ```

* ThroughputC: 16 Threads (3clients x 47 threads x 2, client_id % 16)
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 39.60M     | 165.00ns   | 646.14ns   | 555.00ns   | 1.74us     |
    +------------+------------+------------+------------+------------+------------+
    ```

## use UD

### + UD reply

* Latency
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | client     | 324.05K    | 2.86us     | 3.03us     | 3.00us     | 3.36us     |
    +------------+------------+------------+------------+------------+------------+
    ```


* ThroughputA: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 4.92M      | 290.00ns   | 1.69us     | 1.69us     | 2.95us     |
    +------------+------------+------------+------------+------------+------------+
    ```

* ThroughputB: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 28.26M     | 155.00ns   | 840.89ns   | 655.00ns   | 3.07us     |
    +------------+------------+------------+------------+------------+------------+
    ```

* ThroughputC: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 40.46M     | 115.00ns   | 581.77ns   | 505.00ns   | 1.44us     |
    +------------+------------+------------+------------+------------+------------+
    ```

### + UD send & reply

* ThroughputA: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 6.07M      | 175.00ns   | 768.76ns   | 725.00ns   | 1.60us     |
    +------------+------------+------------+------------+------------+------------+
    ```

* ThroughputB: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 45.02M     | 115.00ns   | 495.60ns   | 410.00ns   | 1.38us     |
    +------------+------------+------------+------------+------------+------------+
    ```

* ThroughputC: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 44.31M     | 120.00ns   | 463.05ns   | 405.00ns   | 1.11us     |
    +------------+------------+------------+------------+------------+------------+
    ```


## use SRQ

* ThroughputA: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 2.68M      | 150.00ns   | 411.40ns   | 325.00ns   | 1.08us     |
    +------------+------------+------------+------------+------------+------------+
    ```

* ThroughputB: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 17.09M     | 195.00ns   | 487.95ns   | 415.00ns   | 1.48us     |
    +------------+------------+------------+------------+------------+------------+
    ```

### + MP 

* ThroughputA: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 3.82M      | 120.00ns   | 221.52ns   | 205.00ns   | 385.00ns   |
    +------------+------------+------------+------------+------------+------------+
    ```

* ThroughputB: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 27.15M     | 150.00ns   | 545.28ns   | 360.00ns   | 2.47us     |
    +------------+------------+------------+------------+------------+------------+
    ```
* FIXME: ThroughputB:
    When we **reduce the request pressure from clients** (x4 -> x2), SRQ has a better performance.
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 31.32M     | 140.00ns   | 467.86ns   | 335.00ns   | 2.00us     |
    +------------+------------+------------+------------+------------+------------+
    ```
* FIXME: ThroughputA:
    When we **reduce the msg size** (64B -> 4B), SRQ has a better performance.
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 4.01M      | 115.00ns   | 210.06ns   | 195.00ns   | 370.00ns   |
    +------------+------------+------------+------------+------------+------------+
    ```

* (Memory Ordered Processing) ThroughputB: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 25.93M     | 130.00ns   | 575.09ns   | 365.00ns   | 2.66us     |
    +------------+------------+------------+------------+------------+------------+
    ```

### + MP, + UD reply

* ThroughputA: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 6.35M      | 150.00ns   | 621.73ns   | 580.00ns   | 1.29us     |
    +------------+------------+------------+------------+------------+------------+
    ```

* ThroughputB: 
    ```
    +------------+------------+------------+------------+------------+------------+
    | name       | ops/s      | fast       | ave        | p50        | p99        |
    +------------+------------+------------+------------+------------+------------+
    | server     | 46.37M     | 115.00ns   | 450.89ns   | 370.00ns   | 1.23us     |
    +------------+------------+------------+------------+------------+------------+
    ```


## use DCT

## Normal Experiments

### -Inline

### -Batch post send reply

### -Batch post recv reply

### -Batch poll cq

### -Doorbell Batching





